<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="utils.js" type="text/javascript"></script>
<script src="env.js" type="text/javascript"></script>
<script src="issue1299.js" type="text/javascript"></script>
<script>
var index = location.href.lastIndexOf(".");
var requestUri = location.href.substr(0, index) + ".js";

function checkResponseTabPhase1()
{
    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    fireunit.FBTrace.sysout("fireunit.issue1299.checkResponseTabPhase1");

    // Remove the file from Firebug cache and try to request it again using 
    // XHR. The response should come from Firefox Cache and Firebug should
    // cache it again.
    fireunit.FirebugContext.sourceCache.invalidate(requestUri);

    var request = new XMLHttpRequest();
    request.onreadystatechange = function(){
        if (request.readyState == 4 && request.status == 200) 
            setTimeout(function(){
                checkResponseTabPhase2(request);
            }, layoutTimeout);
    };
    request.open("GET", requestUri, true);
    request.send(null);
}

function checkResponseTabPhase2(request)
{
    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    fireunit.FBTrace.sysout("fireunit.issue1299.checkResponseTabPhase2", request);

    var text = fireunit.FirebugContext.sourceCache.loadText(requestUri);
    fireunit.FBTrace.sysout("fireunit.issue1299.Firebug cache for " + requestUri, text);
    fireunit.compare(request.responseText, text, "Firebug cache must provide the same" +
        "content that is returned from Firefox cache.");

    // Finish test
    fireunit.FBTrace.sysout("fireunit.issue1299.DONE");
    fireunit.testDone();
}

// Run the test function using timeout.
setTimeout(checkResponseTabPhase1, 100);

</script>
</head>
<body>
<h1>Test Case for Issue #1299</h1>
</body>
</html>
