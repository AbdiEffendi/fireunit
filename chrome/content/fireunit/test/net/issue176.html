<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script src="utils.js" type="text/javascript"></script>
<script src="env.js" type="text/javascript"></script>
<script>
netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");

// Get current request URI without the file extension.
var index = location.pathname.lastIndexOf(".");
var requestUri = location.pathname.substr(0, index);

// Implementation of a request handler (serve side)
function requestHandler(metadata, response) {
    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    
    var path = metadata.path;
    fireunit.FBTrace.sysout("fireunit.issue176.pathHandler executed: " + path, 
        [metadata, response]);
    
    var extension = path.substr(path.lastIndexOf(".") + 1);
    response.setHeader("Content-Type", (extension == "txt" ? "video/x-flv" : ""), false);
    response.write("counter++;");
} 

// Register request handler for two different URLs
fireunit.registerPathHandler(requestUri + ".flv", requestHandler);
fireunit.registerPathHandler(requestUri + ".txt", requestHandler);

var counter = 0;
var uris = ["issue176.txt", "issue176.flv"];

// Embed two files into the page as scripts.
var head = document.getElementsByTagName("head")[0];
for (var i=0; i<uris.length; i++) {
    script = document.createElement("script");
    script.setAttribute("type", "text/javascript");
    script.setAttribute("src", uris[i]);
    head.appendChild(script);
}

// Wait till the response is returned from the server.
var maxPendingCheck = 10;
function waitForResponse() {
    setTimeout(function() {
        if (counter > 1) {
            checkNetPanelUI();
        }
        else {
            if (--maxPendingCheck > 0)
                waitForResponse();
        }        
    }, layoutTimeout);
};
waitForResponse();

// Make sure the Net panel's UI is properly filtered.
function checkNetPanelUI()
{
    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    fireunit.FBTrace.sysout("fireunit.issue176.checkNetPanelUI " + counter);

    // Open Firebug UI and activate Net panel.
    fireunit.Firebug.showBar(true);
    fireunit.FirebugChrome.selectPanel("net");

    // Set "Flash" filter
    fireunit.Firebug.NetMonitor.onToggleFilter(fireunit.FirebugContext, "flash");
    
    // Wait for relayout.
    setTimeout(function() 
    {
        netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");

        // Get Net panel content
	    var panelNode = fireunit.panel("net");
        fireunit.ok(panelNode, "Net panel must exist.");

        // Check number of requests. Must be exactly two.
        var netRows = getElementsByClass(panelNode, "netRow", "category-flash", "hasHeaders", "loaded");
        fireunit.ok(netRows.length == 2, "There must be exactly two requests displayed!");

        // Finish test
        fireunit.Firebug.NetMonitor.onToggleFilter(fireunit.FirebugContext, "all");
        fireunit.FBTrace.sysout("fireunit.issue176.DONE");    
        fireunit.testDone();    
    }, layoutTimeout);
}
</script>
</head>
<body>
<h1>Test Case for Issue #176</h1>
</body>
</html>
